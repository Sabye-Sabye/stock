<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏´‡∏∏‡πâ‡∏ô + Trailing Stop (30 ‡∏ß‡∏±‡∏ô)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏ô iPhone / Add to Home Screen -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Stock" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f4f5fb;
    }

    h1 {
      margin-bottom: 0.5rem;
    }

    .note {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    .field {
      display: flex;
      flex-direction: column;
      min-width: 120px;
    }

    .field label {
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .field input {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th:nth-child(1),
    th:nth-child(2),
    th:nth-child(3),
    td:nth-child(1),
    td:nth-child(2),
    td:nth-child(3) {
      text-align: left;
    }

    tr:hover {
      background: #f3f4ff;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eef2ff;
      color: #3730a3;
    }

    .pl-positive {
      color: #16a34a;
      font-weight: 600;
    }

    .pl-negative {
      color: #dc2626;
      font-weight: 600;
    }

    .small {
      font-size: 0.8rem;
      color: #6b7280;
    }

    input.price-input {
      width: 80px;
      text-align: right;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      table {
        font-size: 0.8rem;
      }
      form {
        flex-direction: column;
        align-items: stretch;
      }
      .field {
        width: 100%;
      }
      input.price-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏´‡∏∏‡πâ‡∏ô + Trailing Stop (30 ‡∏ß‡∏±‡∏ô)</h1>
  <div class="note">
    üì± ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å iPhone ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ <b>‚ÄúAdd to Home Screen‚Äù</b> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ<br />
    ‚ú≥Ô∏è ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞ Highest 30 ‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å <b>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</b> ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà
  </div>

  <div class="card">
    <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏∏‡πâ‡∏ô</h2>
    <form id="stock-form">
      <div class="field">
        <label for="symbol">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏∏‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô AOT)</label>
        <input id="symbol" required />
      </div>
      <div class="field">
        <label for="shares">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏∏‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 100)</label>
        <input id="shares" type="number" step="1" min="0" required />
      </div>
      <div class="field">
        <label for="buyPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
        <input id="buyPrice" type="number" step="0.01" min="0" required />
      </div>
      <div class="field">
        <label for="currentPrice">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
        <input id="currentPrice" type="number" step="0.01" min="0" />
      </div>
      <div class="field">
        <label for="trailingPercent">Trailing Stop %</label>
        <input id="trailingPercent" type="number" step="0.1" min="0" value="10" />
      </div>
      <button type="submit" class="btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï</button>
    </form>
  </div>

  <div class="card">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏ô‡∏û‡∏≠‡∏£‡πå‡∏ï</h2>
    <div class="small">
      - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô browser (localStorage)<br />
      - Highest 30 ‡∏ß‡∏±‡∏ô = ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏£‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤<br />
      - ‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡πÅ‡∏•‡∏∞ Trailing Stop ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    </div>
    <div style="overflow-x: auto; max-height: 60vh; margin-top: 10px;">
      <table id="portfolio-table">
        <thead>
          <tr>
            <th>‡∏•‡∏ö</th>
            <th>‡∏´‡∏∏‡πâ‡∏ô</th>
            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</th>
            <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
            <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô</th>
            <th>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
            <th>‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</th>
            <th>% P/L</th>
            <th>Highest 30d</th>
            <th>Trailing %</th>
            <th>Trailing Stop</th>
          </tr>
        </thead>
        <tbody id="portfolio-body">
          <!-- rows will be injected here -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const DEFAULT_TRAILING_PERCENT = 10;
    const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;

    // ====== Data Model & Storage ======
    let portfolio = normalizePortfolio(loadPortfolio());

    function loadPortfolio() {
      try {
        const raw = localStorage.getItem("portfolio");
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse portfolio from localStorage", e);
        return [];
      }
    }

    function normalizePortfolio(pf) {
      const now = Date.now();
      return (pf || []).map((s) => {
        let history = s.history || [];
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ history ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠ highest ‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á history ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ
        if (history.length === 0) {
          if (s.currentPrice != null && !isNaN(Number(s.currentPrice))) {
            history.push({ time: now, price: Number(s.currentPrice) });
          } else if (s.highestPrice != null && !isNaN(Number(s.highestPrice))) {
            history.push({ time: now, price: Number(s.highestPrice) });
          }
        }
        // ‡∏ï‡∏±‡∏î history ‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô‡∏ó‡∏¥‡πâ‡∏á
        const filtered = history.filter((p) => now - p.time <= THIRTY_DAYS_MS);
        let highest = null;
        if (filtered.length > 0) {
          highest = filtered.reduce(
            (max, p) => (p.price > max ? p.price : max),
            filtered[0].price
          );
        }
        return {
          id: s.id || Date.now().toString(),
          symbol: s.symbol,
          shares: s.shares,
          buyPrice: s.buyPrice,
          currentPrice: s.currentPrice ?? null,
          trailingPercent: s.trailingPercent ?? DEFAULT_TRAILING_PERCENT,
          history: filtered,
          highestPrice: highest, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢: highest 30 ‡∏ß‡∏±‡∏ô
        };
      });
    }

    function savePortfolio() {
      localStorage.setItem("portfolio", JSON.stringify(portfolio));
    }

    function addStock(stock) {
      portfolio.push(stock);
      savePortfolio();
      renderTable();
    }

    function removeStock(id) {
      portfolio = portfolio.filter((s) => s.id !== id);
      savePortfolio();
      renderTable();
    }

    function updateStock(id, changes) {
      portfolio = portfolio.map((s) => {
        if (s.id === id) {
          return { ...s, ...changes };
        }
        return s;
      });
      savePortfolio();
      renderTable();
    }

    function updatePriceForStock(id, newPrice) {
      const now = Date.now();
      portfolio = portfolio.map((s) => {
        if (s.id !== id) return s;

        const history = s.history || [];
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏ñ‡πâ‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏á
        if (newPrice == null || isNaN(newPrice)) {
          return { ...s, currentPrice: null };
        }

        const extended = [...history, { time: now, price: newPrice }];
        const filtered = extended.filter((p) => now - p.time <= THIRTY_DAYS_MS);

        let highest = newPrice;
        if (filtered.length > 0) {
          highest = filtered.reduce(
            (max, p) => (p.price > max ? p.price : max),
            filtered[0].price
          );
        }

        return {
          ...s,
          currentPrice: newPrice,
          history: filtered,
          highestPrice: highest,
        };
      });

      savePortfolio();
      renderTable();
    }

    // ====== Rendering ======
    function formatNumber(num, decimals = 2) {
      if (num == null || isNaN(num)) return "-";
      return Number(num).toLocaleString("th-TH", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals,
      });
    }

    function renderTable() {
      const tbody = document.getElementById("portfolio-body");
      tbody.innerHTML = "";

      portfolio.forEach((stock) => {
        const {
          id,
          symbol,
          shares,
          buyPrice,
          currentPrice,
          highestPrice,
          trailingPercent,
        } = stock;

        const sharesNum = Number(shares) || 0;
        const buyNum = Number(buyPrice) || 0;
        const currentNum =
          currentPrice != null && !isNaN(currentPrice)
            ? Number(currentPrice)
            : null;

        const invested = sharesNum * buyNum;
        const currentValue = currentNum != null ? sharesNum * currentNum : null;
        const plValue =
          currentValue != null && invested > 0 ? currentValue - invested : null;
        const plPercent =
          plValue != null && invested > 0 ? (plValue / invested) * 100 : null;

        const highestNum =
          highestPrice != null && !isNaN(highestPrice)
            ? Number(highestPrice)
            : currentNum;
        const trailPercent =
          trailingPercent != null ? Number(trailingPercent) : DEFAULT_TRAILING_PERCENT;

        const trailingStop =
          highestNum != null && !isNaN(highestNum)
            ? highestNum * (1 - trailPercent / 100)
            : null;

        const tr = document.createElement("tr");

        // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        const tdDelete = document.createElement("td");
        tdDelete.innerHTML = `<button class="btn-secondary" style="padding:2px 6px" data-id="${id}">x</button>`;
        tdDelete.style.textAlign = "center";
        tr.appendChild(tdDelete);

        // ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏∏‡πâ‡∏ô
        const tdSymbol = document.createElement("td");
        tdSymbol.innerHTML = `<span class="tag">${symbol}</span>`;
        tr.appendChild(tdSymbol);

        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
        const tdShares = document.createElement("td");
        tdShares.textContent = formatNumber(sharesNum, 0);
        tr.appendChild(tdShares);

        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠
        const tdBuy = document.createElement("td");
        tdBuy.textContent = formatNumber(buyNum);
        tr.appendChild(tdBuy);

        // ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)
        const tdCurrent = document.createElement("td");
        const inputCurrent = document.createElement("input");
        inputCurrent.type = "number";
        inputCurrent.step = "0.01";
        inputCurrent.min = "0";
        inputCurrent.className = "price-input";
        inputCurrent.value =
          currentNum != null && !isNaN(currentNum) ? currentNum : "";
        inputCurrent.addEventListener("change", (e) => {
          const val = e.target.value;
          if (val === "") {
            updatePriceForStock(id, null);
          } else {
            updatePriceForStock(id, Number(val));
          }
        });
        tdCurrent.appendChild(inputCurrent);
        tr.appendChild(tdCurrent);

        // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡∏ó‡∏∏‡∏ô
        const tdInvested = document.createElement("td");
        tdInvested.textContent = formatNumber(invested);
        tr.appendChild(tdInvested);

        // ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const tdCurVal = document.createElement("td");
        tdCurVal.textContent =
          currentValue != null ? formatNumber(currentValue) : "-";
        tr.appendChild(tdCurVal);

        // ‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô
        const tdPL = document.createElement("td");
        if (plValue != null) {
          tdPL.textContent = formatNumber(plValue);
          tdPL.className = plValue >= 0 ? "pl-positive" : "pl-negative";
        } else {
          tdPL.textContent = "-";
        }
        tr.appendChild(tdPL);

        // % PL
        const tdPLPercent = document.createElement("td");
        if (plPercent != null) {
          tdPLPercent.textContent = formatNumber(plPercent, 2) + " %";
          tdPLPercent.className = plValue >= 0 ? "pl-positive" : "pl-negative";
        } else {
          tdPLPercent.textContent = "-";
        }
        tr.appendChild(tdPLPercent);

        // Highest 30d
        const tdHigh = document.createElement("td");
        tdHigh.textContent =
          highestNum != null && !isNaN(highestNum)
            ? formatNumber(highestNum)
            : "-";
        tr.appendChild(tdHigh);

        // Trailing %
        const tdTrailPercent = document.createElement("td");
        const inputTrail = document.createElement("input");
        inputTrail.type = "number";
        inputTrail.step = "0.1";
        inputTrail.min = "0";
        inputTrail.value = trailPercent;
        inputTrail.style.width = "60px";
        inputTrail.addEventListener("change", (e) => {
          updateStock(id, { trailingPercent: Number(e.target.value) });
        });
        tdTrailPercent.appendChild(inputTrail);
        tr.appendChild(tdTrailPercent);

        // Trailing Stop
        const tdTrailStop = document.createElement("td");
        tdTrailStop.textContent =
          trailingStop != null && !isNaN(trailingStop)
            ? formatNumber(trailingStop)
            : "-";
        tr.appendChild(tdTrailStop);

        tbody.appendChild(tr);
      });

      // bind delete buttons
      tbody.querySelectorAll("button[data-id]").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏û‡∏≠‡∏£‡πå‡∏ï?")) {
            removeStock(id);
          }
        });
      });
    }

    // ====== Event Listeners ======
    document
      .getElementById("stock-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const symbol = document.getElementById("symbol").value.trim().toUpperCase();
        const shares = Number(document.getElementById("shares").value);
        const buyPrice = Number(document.getElementById("buyPrice").value);
        const currentPriceInput = document.getElementById("currentPrice").value;
        const currentPrice =
          currentPriceInput === "" ? null : Number(currentPriceInput);
        const trailingPercentRaw =
          document.getElementById("trailingPercent").value;
        const trailingPercent =
          trailingPercentRaw === ""
            ? DEFAULT_TRAILING_PERCENT
            : Number(trailingPercentRaw);

        if (!symbol || shares <= 0 || buyPrice <= 0) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }

        const now = Date.now();
        let history = [];
        let highest = null;

        if (currentPrice != null && !isNaN(currentPrice)) {
          history = [{ time: now, price: currentPrice }];
          highest = currentPrice;
        }

        const newStock = {
          id: Date.now().toString(),
          symbol,
          shares,
          buyPrice,
          currentPrice,
          highestPrice: highest, // highest ‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
          trailingPercent,
          history,
        };

        addStock(newStock);

        // clear form
        document.getElementById("symbol").value = "";
        document.getElementById("shares").value = "";
        document.getElementById("buyPrice").value = "";
        document.getElementById("currentPrice").value = "";
        // trailingPercent ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
      });

    // ====== Initial Render ======
    renderTable();
  </script>
</body>
</html>
